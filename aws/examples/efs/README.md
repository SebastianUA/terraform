# Work with EFS via terraform

A terraform module for making EFS.


## Usage
----------------------
Import the module and retrieve with ```terraform get``` or ```terraform get --update```. Adding a module resource to your template, e.g. `main.tf`:

```
#
# MAINTAINER Vitaliy Natarov "vitaliy.natarov@yahoo.com"
#
terraform {
  required_version = "~> 1.0"
}

provider "aws" {
  region                  = "us-west-2"
  shared_credentials_file = pathexpand("~/.aws/credentials")
  profile                 = "default"
}

module "efs" {
  source      = "../../modules/efs"
  name        = "TEST"
  environment = "nonprod"

  # EFS FS
  enable_efs_file_system           = true
  efs_file_system_name             = ""
  efs_file_system_encrypted        = false
  efs_file_system_kms_key_id       = ""
  efs_file_system_performance_mode = "generalPurpose"

  efs_file_system_lifecycle_policy = [
    {
      transition_to_ia = "AFTER_90_DAYS"
    }
  ]

  # EFS mount target
  enable_efs_mount_target          = true
  efs_mount_target_subnet_ids      = ["subnet-0e2b323b731655057", "subnet-0ffa47878036f1641", "subnet-096406cfdf907ee11"]
  efs_mount_target_security_groups = ["sg-07b62c0d0ea37056d"]

  # EFS access point
  enable_efs_access_point = true
  efs_access_point_name   = ""

  efs_access_point_posix_user = [
    {
      gid = "666"
      uid = "666"
    }
  ]
  efs_access_point_root_directory = []

  tags = tomap({
    "Environment"   = "dev",
    "Createdby"     = "Vitaliy Natarov",
    "Orchestration" = "Terraform"
  })
}

module "efs_policy" {
  source      = "../../modules/efs"
  name        = "TEST"
  environment = "nonprod"

  # EFS FS policy
  enable_efs_file_system_policy         = true
  efs_file_system_policy_file_system_id = module.efs.efs_file_system_arn
  efs_file_system_policy_policy         = <<POLICY
{
    "Version": "2012-10-17",
    "Id": "ExamplePolicy01",
    "Statement": [
        {
            "Sid": "ExampleStatement01",
            "Effect": "Allow",
            "Principal": {
                "AWS": "*"
            },
            "Resource": "${module.efs.efs_file_system_arn}",
            "Action": [
                "elasticfilesystem:ClientMount",
                "elasticfilesystem:ClientWrite"
            ],
            "Condition": {
                "Bool": {
                    "aws:SecureTransport": "true"
                }
            }
        }
    ]
}
POLICY

  tags = tomap({
    "Environment"   = "dev",
    "Createdby"     = "Vitaliy Natarov",
    "Orchestration" = "Terraform"
  })

  depends_on = [
    module.efs
  ]
}

```

## Module Input Variables
----------------------
- `name` - Name to be used on all resources as prefix (`default = TEST`)
- `environment` - Environment for service (`default = STAGE`)
- `tags` - A list of tag blocks. (`default = {}`)
- `enable_efs_file_system` - Enable EFS usage (`default = False`)
- `efs_file_system_name` - Set name for AWS EFS (`default = ""`)
- `efs_file_system_performance_mode` - The file system performance mode. Can be either 'generalPurpose' or 'maxIO' (Default: 'generalPurpose'). (`default = generalPurpose`)
- `efs_file_system_encrypted` - If true, the disk will be encrypted. (`default = True`)
- `efs_file_system_kms_key_id` - The ARN for the KMS encryption key. When specifying kms_key_id, encrypted needs to be set to true. (`default = ""`)
- `efs_file_system_creation_token` - (Optional) A unique name (a maximum of 64 characters are allowed) used as reference when creating the Elastic File System to ensure idempotent file system creation. By default generated by Terraform. See Elastic File System user guide for more information. (`default = ""`)
- `efs_file_system_provisioned_throughput_in_mibps` - (Optional) The throughput, measured in MiB/s, that you want to provision for the file system. Only applicable with throughput_mode set to provisioned. (`default = null`)
- `efs_file_system_throughput_mode` - (Optional) Throughput mode for the file system. Defaults to bursting. Valid values: bursting, provisioned. When using provisioned, also set provisioned_throughput_in_mibps. (`default = null`)
- `efs_file_system_lifecycle_policy` - (Optional) A file system lifecycle policy object (`default = []`)
- `enable_efs_mount_target` - Enable EFS mount target usage (`default = False`)
- `efs_mount_target_subnet_ids` - The ID of the subnets to add the mount target in. (`default = []`)
- `efs_mount_target_file_system_id` - (Required) The ID of the file system for which the mount target is intended. (`default = ""`)
- `efs_mount_target_ip_address` - (Optional) The address (within the address range of the specified subnet) at which the file system may be mounted via the mount target. (`default = null`)
- `efs_mount_target_security_groups` - description (`default = []`)
- `enable_efs_file_system_policy` - Enable EFS file system policy usage (`default = False`)
- `efs_file_system_policy_file_system_id` - The ID of the EFS file system. (`default = ""`)
- `efs_file_system_policy_policy` - (Required) The JSON formatted file system policy for the EFS file system. see Docs for more info. (`default = null`)
- `enable_efs_access_point` - Enable EFS access point usage (`default = False`)
- `efs_access_point_file_system_id` - The ID of the file system for which the access point is intended. (`default = ""`)
- `efs_access_point_name` - Set name for EFS access point (`default = ""`)
- `efs_access_point_posix_user` - (Optional) The operating system user and group applied to all file system requests made using the access point. (`default = []`)
- `efs_access_point_root_directory` - (Optional) Specifies the directory on the Amazon EFS file system that the access point provides access to.  (`default = []`)

## Module Output Variables
----------------------
- `efs_file_system_id` - The ID that identifies the file system (e.g. fs-ccfc0d65).
- `efs_file_system_arn` - Amazon Resource Name of the file system.
- `efs_file_system_kms_key_id` - ""
- `efs_file_system_dns_name` - The DNS name for the filesystem per documented convention.
- `efs_mount_target_id` - The ID of the mount target.
- `efs_mount_target_dns_name` - The DNS name for the EFS file system.
- `efs_mount_target_mount_target_dns_name` - The DNS name for the given subnet/AZ per documented convention.
- `efs_mount_target_file_system_arn` - Amazon Resource Name of the file system.
- `efs_mount_target_network_interface_id` - The ID of the network interface that Amazon EFS created when it created the mount target.
- `efs_mount_target_availability_zone_name` - The name of the Availability Zone (AZ) that the mount target resides in.
- `efs_mount_target_availability_zone_id` - The unique and consistent identifier of the Availability Zone (AZ) that the mount target resides in.
- `efs_mount_target_owner_id` - AWS account ID that owns the resource.
- `efs_file_system_policy_id` - The ID that identifies the file system (e.g. fs-ccfc0d65).
- `efs_access_point_id` - The ID of the access point.
- `efs_access_point_arn` - Amazon Resource Name of the access point.
- `efs_access_point_file_system_arn` - Amazon Resource Name of the file system.


## Authors

Created and maintained by [Vitaliy Natarov](https://github.com/SebastianUA). An email: [vitaliy.natarov@yahoo.com](vitaliy.natarov@yahoo.com).

## License

Apache 2 Licensed. See [LICENSE](https://github.com/SebastianUA/terraform/blob/master/LICENSE) for full details.
